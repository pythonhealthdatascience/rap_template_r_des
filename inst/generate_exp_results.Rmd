---
title: "Generate expected results"
output: html_document
---

This notebook is used to run a specific version of the model and save each results dataframe as a csv. These are used in `test-backtest.R` to verify that the model produces consistent results.

The `.Rmd` file is provided as it is possible that results may change due to alterations to the model structure and operations. Once it has been confirmed that changes are intentional and not any introduced errors, this script can be run to regenerate the `.csv` files used in the test.

The run time is provided at the end of this notebook.

## Set-up

Load required packages.

```{r setup}
library(simmer)
library(simulation)
```

Start timer.

```{r start_timer}
start_time <- Sys.time()
```

Define path to expected results.

```{r path}
tests <- "../tests/testthat/testdata/"
```

## Run model and save results

```{r}
# Define model parameters
param <- defaults()
param["patient_inter"] <- 4.0
param["mean_n_consult_time"] <- 10.0
param["number_of_nurses"] <- 5.0
param["data_collection_period"] <- 80.0
param["number_of_runs"] <- 10.0
param["cores"] <- 1.0

# Run the trial
envs <- trial(param = param)
```

```{r}
# Monitored data about arrivals
result_arrivals <- do.call(rbind, lapply(envs, get_mon_arrivals))
write.csv(result_arrivals, file.path(tests, "arrivals.csv"), row.names = FALSE)
```

```{r}
# Monitored data about resources
result_resources <- do.call(rbind, lapply(envs, get_mon_resources))
write.csv(result_resources, file.path(tests, "resources.csv"), row.names = FALSE)
```

## Calculate run time

```{r end_timer}
# Get run time in seconds 
end_time <- Sys.time()
runtime <- as.numeric(end_time - start_time, units="secs")

# Display converted to minutes and seconds
minutes <- as.integer(runtime / 60)
seconds <- as.integer(runtime %% 60)
print(sprintf("Notebook run time: %dm %ds", minutes, seconds))
```
