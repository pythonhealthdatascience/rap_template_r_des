---
title: "Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Trial execution}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

To knit this vignette, will first need to run `devtools::install()` to fetch the latest version of our `simulation` model code.

```{r, include = FALSE}
knitr::opts_chunk[["set"]](
  collapse = TRUE,
  comment = "#>"
)
```

## Set up

Import required packages.

```{r}
# nolint start: undesirable_function_linter.
library(simmer)
library(simmer.plot)
library(simulation)

options(dplyr.summarise.inform = FALSE)
# nolint end
```

Start timer.

```{r}
start_time <- Sys.time()
```

Define path to outputs folder.

```{r}
# TODO: Determine appropriate location for saving output data (given package
# structure), then save all files below.
# output_dir = file.path("../outputs/")
```

## Default run

Run with default parameters.

```{r}
envs <- trial(param = defaults())
```

Process results and save to `.csv`.

```{r}
trial_results <- process_replications(envs)
head(trial_results)

# trial_results.to_csv
```

## View spread of results across replication

```{r}
# TODO: Add these plots
# TODO: Remove simmer.plot() if not used anywhere
```

## Scenario analysis

```{r}
# TODO: Set up as function
# TODO: Use process_replications

scenarios <- list(
  patient_inter = c(3L, 4L, 5L, 6L, 7L),
  number_of_nurses = c(5L, 6L, 7L, 8L)
)

# Generate all permutations of the scenarios
all_scenarios <- expand.grid(scenarios)

# Preview the number of scenarios
print(sprintf("There are %d scenarios. Running:", nrow(all_scenarios)))

results_resources <- list()
results_arrivals <- list()

# Iterate through each scenario
for (index in seq_len(nrow(all_scenarios))) {

  # Filter to one of the scenarios
  scenario_to_run <- all_scenarios[index, ]

  # Print the scenario parameters
  formatted_scenario <- toString(
    paste0(names(scenario_to_run), " = ", scenario_to_run)
  )
  print(paste0("Scenario: ", formatted_scenario))

  # Overwrite defaults with scenario-specific values
  param <- defaults()
  param[["scenario_name"]] <- index
  for (key in names(scenario_to_run)) {
    param[[key]] <- scenario_to_run[[key]]
  }

  # Run the trial for the current scenario
  envs <- trial(param)

  # Extract results
  trial_resources <- do.call(rbind, lapply(envs, get_mon_resources))
  trial_arrivals <- do.call(rbind, lapply(envs, get_mon_arrivals))

  # Append scenario parameters to the results
  trial_resources[["scenario"]] <- index
  trial_arrivals[["scenario"]] <- index
  for (key in names(scenario_to_run)) {
    trial_resources[[key]] <- scenario_to_run[[key]]
    trial_arrivals[[key]] <- scenario_to_run[[key]]
  }

  # Append to results list
  results_resources[[index]] <- trial_resources
  results_arrivals[[index]] <- trial_arrivals
}
```

## Sensitivity analysis

```{r}
# TODO: Add sensitivity analysis
```

## Calculate run time

```{r end_timer}
# Get run time in seconds
end_time <- Sys.time()
runtime <- as.numeric(end_time - start_time, units = "secs")

# Display converted to minutes and seconds
minutes <- as.integer(runtime / 60L)
seconds <- as.integer(runtime %% 60L)
print(sprintf("Notebook run time: %dm %ds", minutes, seconds))
```
